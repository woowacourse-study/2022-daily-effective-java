# ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ëŠ” ì£¼ì˜í•´ì„œ ì ìš©í•˜ì!!
`ì—˜ë¦¬`
> ì•„ì´í…œ 45. ìŠ¤íŠ¸ë¦¼ì€ ì£¼ì˜í•´ì„œ ì‚¬ìš©í•˜ë¼  
ê¸°ë³¸ì ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸ì€ `ìˆœì°¨ì `ìœ¼ë¡œ ìˆ˜í–‰ëœë‹¤.  
íŒŒì´í”„ë¼ì¸ì„ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ë ¤ë©´ íŒŒì´í”„ë¼ì¸ì„ êµ¬ì„±í•˜ëŠ” ìŠ¤íŠ¸ë¦¼ ì¤‘ í•˜ë‚˜ì—ì„œ `parallel ë©”ì„œë“œ`ë¥¼ í˜¸ì¶œí•´ì£¼ê¸°ë§Œ í•˜ë©´ ë˜ë‚˜, **íš¨ê³¼ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” ìƒí™©ì€ ë§ì§€ ì•Šë‹¤.** 

### 1. ê³„ì‚° ê²°ê³¼ê°€ ì •í™•í•˜ê³  2. ì„±ëŠ¥ë„ ì¢‹ì•„ì§ˆ ê²ƒì´ë¼ëŠ” í™•ì‹ ì´ ì—†ë‹¤ë©´ ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ë¥¼ ì ìš©í•˜ì§€ ë§ì!!
ê³„ì‚°ëŸ‰ì´ ë§ê±°ë‚˜ ë¹…ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê±°ë‚˜ ì„±ëŠ¥ ìµœì í™”ê°€ í•„ìš”í•œ ìƒí™©ì—ì„œ `ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”`ëŠ” ë§¤ë ¥ì ì´ê²Œ ë³´ì¼ ìˆ˜ ìˆë‹¤.   
ëª¨ë“  ë™ì‹œì„± í”„ë¡œê·¸ë˜ë°ì—ì„œëŠ” `ì•ˆì „ì„±(safety)`ê³¼ `ì‘ë‹µ ê°€ëŠ¥(liveness)`ìƒíƒœë¥¼ ìœ ì§€í•´ì•¼ í•˜ëŠ”ë°,  
ìŠ¤íŠ¸ë¦¼ì„ ì˜ëª» ë³‘ë ¬í™”í•˜ë©´ ì˜¤íˆë ¤ í”„ë¡œê·¸ë¨ì„ `ì˜¤ì‘ë™` í˜¹ì€ `ì‘ë‹µ ë¶ˆê°€`í•˜ê²Œ ë§Œë“¤ê±°ë‚˜ `ì„±ëŠ¥ì„ ê¸‰ê²©íˆ ë–¨ì–´ëœ¨ë¦´ ìˆ˜ ìˆë‹¤.`

## ì†Œìˆ˜ ê³„ì‚° í”„ë¡œê·¸ë¨ ğŸ‘
> në³´ë‹¤ ì‘ê±°ë‚˜ ê°™ì€ ì†Œìˆ˜ì˜ ê°œìˆ˜ë¥¼ ê³„ì‚°í•œë‹¤.
```java
@Test
void countPrime() {
    System.out.println(pi(100_000_000));
}

private long pi(long n) {
    return LongStream.rangeClosed(2, n)
            .parallel() // ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”
            .mapToObj(BigInteger::valueOf)
            .filter(i -> i.isProbablePrime(50))
            .count();
}
```
```shell
// ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™” ì „
5761455
BUILD SUCCESSFUL in 2m 38s
// ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™” í›„
5761455
BUILD SUCCESSFUL in 40s
```

## ì²˜ìŒ 20ê°œì˜ ë©”ë¥´ì„¼ ì†Œìˆ˜ë¥¼ ìƒì„±í•˜ëŠ” í”„ë¡œê·¸ë¨ ğŸ‘
> ë©”ë¥´ì„¼ ì†Œìˆ˜ë€ ì†Œìˆ˜ ê°€ìš´ë° `2^n - 1`ë¡œ í‘œí˜„ë˜ëŠ” ì†Œìˆ˜ì´ë‹¤.

![image](https://user-images.githubusercontent.com/45311765/158413291-dab3e747-e138-4b89-a038-6e41f4fd6ea1.png)

```java
@Test
void generateMersenne() {
    primes().map(p -> TWO.pow(p.intValueExact()).subtract(ONE))
            .filter(mersenne -> mersenne.isProbablePrime(50))
            .limit(20)
            .forEach(System.out::println);
}

static Stream<BigInteger> primes() {
    return Stream.iterate(TWO, BigInteger::nextProbablePrime);
}
```
ë§Œì•½ ê³„ì‚° ì†ë„ë¥¼ ë†’ì´ê³  ì‹¶ì–´ ìŠ¤íŠ¸ë¦¼ íŒŒì´í”„ë¼ì¸ì˜ `parallel()`ì„ í˜¸ì¶œí•´ë²„ë¦¬ë©´ í”„ë¡œê·¸ë¨ì€ `ì‘ë‹µ ë¶ˆê°€(liveness failure)` ìƒíƒœì— ë¹ ì§€ê²Œëœë‹¤. 
````java
@Test
void generateMersenne() {
    primes().map(p -> TWO.pow(p.intValueExact()).subtract(ONE))
            .filter(mersenne -> mersenne.isProbablePrime(50))
            .parallel() // ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”
            .limit(20)
            .forEach(System.out::println);
}
````

## ë°ì´í„° ì†ŒìŠ¤
`parallel()`ì€ ë³‘ë ¬ë¡œ ì‹¤í–‰í•˜ê¸° ìœ„í•´ ë°ì´í„° ì†ŒìŠ¤ë¥¼ ì›í•˜ëŠ” ë‹¨ìœ„ë¡œ ë‚˜ëˆ ì„œ ìŠ¤ë ˆë“œì— ë¶„ë°°í•œë‹¤. 
- ë‚˜ëˆ„ëŠ” ì‘ì—…ì€ [Spliterator](https://java-8-tips.readthedocs.io/en/stable/parallelization.html) ê°€ ë‹´ë‹¹í•œë‹¤. 

### ë³‘ë ¬í™” âŒ
- `Stream.iterate`
  - ìˆœì°¨ì ìœ¼ë¡œ ë‹¤ìŒ ìš”ì†Œë¥¼ ë°˜í™˜í•´ ì›í•˜ëŠ” ë‹¨ìœ„ë¡œ ìë¥¼ ìˆ˜ ì—†ë‹¤. 

### ë³‘ë ¬í™” â­•ï¸
- `ArrayList`, `HashMap`, `HashSet`, `ConcurrentHashMap`, `int`, `long`
  - ë°ì´í„°ë¥¼ ì›í•˜ëŠ” í¬ê¸°ë¡œ ì •í™•í•˜ê³  ì‰½ê²Œ ë‚˜ëˆŒ ìˆ˜ ìˆë‹¤. 
  - [ì°¸ì¡° ì§€ì—­ì„±(locality of reference)](https://en.wikipedia.org/wiki/Locality_of_reference) ì´ ë›°ì–´ë‚˜ë‹¤. (= ì´ì›ƒí•œ ì›ì†Œì˜ ì°¸ì¡°ë“¤ì´ ë©”ëª¨ë¦¬ì— ì—°ì†í•´ì„œ ì €ì¥ë˜ì–´ ìˆë‹¤.)
- `SplittableRandom`
  - ëœë¤í•œ ìˆ˜ë“¤ë¡œ ì´ë£¨ì–´ì§„ ìŠ¤íŠ¸ë¦¼ì„ ë³‘ë ¬í™” í• ë•Œ ì‚¬ìš©í•œë‹¤.

## ì¤‘ê°„ ì—°ì‚°
### ë³‘ë ¬í™” âŒ
- `limit`
  - íŒŒì´í”„ë¼ì¸ ë³‘ë ¬í™”ëŠ” limitì„ ë‹¤ë£° ë•Œ, CPU ì½”ì–´ê°€ ë‚¨ëŠ”ë‹¤ë©´ ì›ì†Œë¥¼ ëª‡ ê°œ ë” ì²˜ë¦¬í•œ í›„ ì œí•œëœ ê°œìˆ˜ ì´í›„ì˜ ê²°ê³¼ë¥¼ ë²„ë ¤ë„ ì•„ë¬´ëŸ° í•´ê°€ ì—†ë‹¤ê³  ê°€ì •í•œë‹¤. 
  - ì†Œìˆ˜ ì°¾ê¸° ì²˜ëŸ¼ ì ì  ìˆ˜í–‰ ì‹œê°„ì´ ê¸¸ì–´ì§€ëŠ” ì¼€ì´ìŠ¤ì˜ ê²½ìš° `ì‘ë‹µ ë¶ˆê°€ ìƒíƒœ`ì— ë¹ ì§ˆ ìˆ˜ ìˆë‹¤. 

## ì¢…ë‹¨ ì—°ì‚°
### ë³‘ë ¬í™” â­•ï¸
- `ì¶•ì†Œ(reduction)` : íŒŒì´í”„ë¼ì¸ì—ì„œ ë§Œë“¤ì–´ì§„ ëª¨ë“  ì›ì†Œë¥¼ í•˜ë‚˜ë¡œ í•©ì¹˜ëŠ” ì‘ì—…
  - Streamì˜ `reduce` í˜¹ì€ `min`, `max`, `count`, `sum`
- ì¡°ê±´ì— ë§ìœ¼ë©´ ë°”ë¡œ ë°˜í™˜ë˜ëŠ” ë©”ì„œë“œ
  - `anyMatch`, `allMatch`, `noneMatch`

### ë³‘ë ¬í™” âŒ
- `ê°€ë³€ ì¶•ì†Œ(mutable reduction)`ë¥¼ ìˆ˜í–‰í•˜ëŠ” Streamì˜ `collect`
  - ì»¬ë ‰ì…˜ë“¤ì„ í•©ì¹˜ëŠ” ë¶€ë‹´ì´ í¬ë‹¤.
  
## ì„±ëŠ¥ ì ê²€ í•„ìš”
- ìŠ¤íŠ¸ë¦¼ ë³‘ë ¬í™”ëŠ” ì˜¤ì§ ì„±ëŠ¥ ìµœì í™” ìˆ˜ë‹¨ì„ì„ ê¸°ì–µí•˜ì!!
- ë³‘ë ¬í™”ì— ë“œëŠ” ì¶”ê°€ ë¹„ìš©ì´ ìˆê¸° ë•Œë¬¸ì— `(ìŠ¤íŠ¸ë¦¼ ì•ˆì˜ ì›ì†Œ ìˆ˜) * (ì›ì†Œë‹¹ ìˆ˜í–‰ë˜ëŠ” ì½”ë“œ ì¤„ ìˆ˜) > ìµœì†Œ ìˆ˜ì‹­ë§Œ`ì€ ë˜ì–´ì•¼ ì„±ëŠ¥ í–¥ìƒì„ ê¸°ëŒ€í•  ìˆ˜ ìˆë‹¤. 
- ìš´ì˜ í™˜ê²½ê³¼ ìœ ì‚¬í•œ ì¡°ê±´ì—ì„œ ìˆ˜í–‰í•´ë³´ë©´ì„œ ì„±ëŠ¥ ì§€í‘œë¥¼ í™•ì¸í•œ í›„ ìš´ì˜ ì½”ë“œì— ìµœì¢… ë°˜ì˜í•œë‹¤. 

## Ref.
- ì°¸ì¡° ì§€ì—­ì„± ì°¸ê³  : https://en.wikipedia.org/wiki/Locality_of_reference
- Java8 Parallel Processing ì°¸ê³  : https://java-8-tips.readthedocs.io/en/stable/parallelization.html

## ê³¼ë„í•œ ë™ê¸°í™”ëŠ” í”¼í•˜ë¼

- **ê³¼ë„í•œ ë™ê¸°í™”ëŠ” ì„±ëŠ¥ì„ ë–¨ì–´ëœ¨ë¦¬ê³ , êµì°©ìƒíƒœì— ë¹ ëœ¨ë¦¬ê³ , ì‹¬ì§€ì–´ ì˜ˆì¸¡í•  ìˆ˜ ì—†ëŠ” ë™ì‘ì„ ë‚³ê¸°ë„ í•œë‹¤.**


### ì™¸ê³„ì¸ì„ ì¡°ì‹¬í•˜ë¼
- ***ë™ê¸°í™”ëœ ì˜ì—­***ì—ì„œëŠ” ì™¸ë¶€ì—ì„œ ë„˜ì–´ì˜¨ í•¨ìˆ˜ ê°ì²´, ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ ì¬ì •ì˜í•  ìˆ˜ ìˆëŠ” ë©”ì„œë“œì™€ ê°™ì€ **ì™¸ê³„ì¸ ë©”ì„œë“œ**ë¥¼ ì¡°ì‹¬í•´ë¼ 
- ë­” ì§“ í• ì§€ ëª¨ë¥¸ë‹¤. ì™¸ê³„ì¸ì€ í•˜ëŠ” ì¼ì— ë”°ë¼ ë™ê¸°í™”ëœ ì˜ì—­ì€ ì˜ˆì™¸ë¥¼ ì¼ìœ¼í‚¤ê±°ë‚˜, êµì°©ìƒíƒœì— ë¹ ì§€ê±°ë‚˜, ë°ì´í„°ê°€ í›¼ì† ë  ìˆ˜ ìˆë‹¤.

### ê´€ì°°ì íŒ¨í„´ ì˜ˆì‹œ
- ê´€ì°°ìë“¤ì€ `addObserver`ì™€ `removeObserver` ë©”ì„œë“œë¥¼ í˜¸ì¶œí•´ êµ¬ë…ì„ ì‹ ì²­í•˜ê±°ë‚˜ í•´ì§€í•œë‹¤.

```java
public class ObservableSet<E> extends ForwardingSet<E> {
    public ObservableSet(Set<E> set) {
        super(set);
    }

    // ê´€ì°°ì ë¦¬ìŠ¤íŠ¸ë¥¼ ë³´ê´€í•˜ê³  ìˆë‹¤.
    private final List<SetObserver<E>> observers = new ArrayList<>(); 

    // ê´€ì°°ìë¥¼ ì¶”ê°€í•œë‹¤.
    public void addObserver(SetObserver<E> observer) { 
        synchronized (observers) {
            observers.add(observer);
        }
    }

    // ê´€ì°°ìë¥¼ ì œê±°í•œë‹¤.
    public boolean removeObserver(SetObserver<E> observer) {
        synchronized (observers) {
            return observers.remove(observer);
        }
    }

    // ì›ì†Œê°€ ì¶”ê°€ ë  ë•Œ observerì˜ added ë©”ì„œë“œë¥¼ ì‹¤í–‰í•œë‹¤.
    private void notifyElementAdded(E element) { 
        synchronized (observers) {
            for (SetObserver<E> observer : observers)
                observer.added(this, element);
        }
    }

    @Override
    public boolean add(E element) {
        boolean added = super.add(element);
        if (added)
            notifyElementAdded(element);
        return added;
    }

    @Override
    public boolean addAll(Collection<? extends E> c) {
        boolean result = false;
        for (E element : c)
            result |= add(element);  // notifyElementAddedë¥¼ í˜¸ì¶œí•œë‹¤.
        return result;
    }
}
```

```java
@FunctionalInterface
public interface SetObserver<E> {
    // ObservableSetì— ì›ì†Œê°€ ë”í•´ì§ˆ ë•Œ í˜¸ì¶œë˜ëŠ” í•¨ìˆ˜
    void added(ObservableSet<E> set, E element);
}
```

- ìœ„ ì½”ë“œëŠ” ì •ìƒì ìœ¼ë¡œ ë™ì‘í•  ê²ƒ ê°™ë‹¤.. í•˜ì§€ë§Œ..?

---
### ì™¸ê³„ì¸ ë©”ì„œë“œì˜ ì˜í–¥ : ì˜ˆì™¸ê°€ í„°ì§„ë‹¤.
```java
public static void main(String[] args) {
    ObservableSet<Integer> set = new ObservableSet<>(new HashSet<>());
    set.addObserver(new SetObserver<>() {
        public void added(ObservableSet<Integer> s, Integer e) {
            System.out.println(e);
            if (e == 23)
                s.removeObserver(this); // ConcurrentModificationExceptionì„ ë˜ì§„ë‹¤.
        }
});

for (int i = 0; i < 100; i++)
    set.add(i;)
}
```

- 23 ê¹Œì§€ ì¶œë ¥í•œ ë‹¤ìŒ `ConcurrentModificationException`ì„ ë˜ì§„ë‹¤.
- added ë©”ì„œë“œ í˜¸ì¶œì´ ì¼ì–´ë‚œ ì‹œì ì´ `notifyElementAdded`ê°€ ê´€ì°°ìë“¤ì˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœíšŒì¤‘ì´ë‹¤.
- ë¦¬ìŠ¤íŠ¸ ìˆœíšŒ ì¤‘ì— ë¦¬ìŠ¤íŠ¸ë¥¼ ì œê±°í•˜ë ¤í•œë‹¤ -> í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë™ì‘ -> ì˜ˆì™¸ê°€ í„°ì§„ë‹¤.ğŸ˜…
- ë™ê¸°í™” ë¸”ë¡ ì•ˆì— ìˆëŠ”ë° ì™œ ì‹¤í–‰ì´ ë˜ì§€? ğŸ¤”
    - `notifyElementAdded` ë©”ì„œë“œì—ì„œ ìˆ˜í–‰í•˜ëŠ” ìˆœíšŒëŠ” ë™ê¸°í™” ë¸”ë¡ ì•ˆì— ìˆìœ¼ë¯€ë¡œ ë™ì‹œ ìˆ˜ì •ì´ ì¼ì–´ë‚˜ì§€ ì•Šë„ë¡ ë³´ì¥í•œë‹¤.
    - í•˜ì§€ë§Œ **ì •ì‘ ìì‹ ì´ ì½œë°±ì„ ê±°ì³ ë˜ëŒì•„ì™€ ìˆ˜ì • í•˜ëŠ” ê²ƒê¹Œì§€ ë§‰ì§€ëŠ” ëª»í•œë‹¤.**

### ì™¸ê³„ì¸ ë©”ì„œë“œì˜ ì˜í–¥ : êµì°©ìƒíƒœ ë°œìƒ

```java
public static void main(String[] args) {
    ObservableSet<Integer> set = new ObservableSet<>(new HashSet<>());

    set.addObserver(new SetObserver<>() {
        public void added(ObservableSet<Integer> s, Integer e) {
            System.out.println(e);
            if (e == 23) {
                ExecutorService exec = Executors.newSingleThreadExecutor();
                try {
                    // ì™¸ë¶€ ìŠ¤ë ˆë“œì—ì„œ removeObserver(this)ë¥¼ í˜¸ì¶œí•˜ê²Œ ëœë‹¤.
                    exec.submit(() -> s.removeObserver(this)).get();
                } catch (ExecutionException | InterruptedException ex) {
                    throw new AssertionError(ex);
                } finally {
                    exec.shutdown();
                }
            }
        }
    })

    for (int i = 0; i < 100; i++) {
        set.add(i);
    }
}
```
- ë‹¤ìŒì˜ ê²½ìš°ì—ëŠ” ì˜ˆì™¸ëŠ” ë‚˜ì§€ ì•Šì§€ë§Œ êµì°©ìƒíƒœì— ë¹ ì§„ë‹¤.
- ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œê°€ s.removeObserver(this)ë¥¼ í˜¸ì¶œí•˜ë©´ ë½ì„ ì–»ì„ ìˆ˜ ì—†ë‹¤. -> ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì¡ê³  ìˆê¸° ë•Œë¬¸
- ë©”ì¸ ìŠ¤ë ˆë“œë„ ë°±ê·¸ë¼ìš´ë“œ ìŠ¤ë ˆë“œê°€ ê´€ì°°ìë¥¼ ì œê±°í•˜ëŠ” ê²ƒì„ ê¸°ë‹¤ë¦°ë‹¤.
- `êµì°©ìƒíƒœ ë°œìƒ ğŸ¤¯`

### ì˜ˆì™¸ / êµì°© í•´ê²° ë°©ë²•

1. ì™¸ê³„ì¸ ë©”ì„œë“œì˜ í˜¸ì¶œì„ ë™ê¸°í™” ë¸”ë¡ ë°”ê¹¥ìœ¼ë¡œ ì˜®ê¸´ë‹¤.

```java
private void notifyElementAdded(E element) {
    List<SetObserver<E>> snapshot = null;
    synchronized (observers) {
        snapshot = new ArrayList<>(observers);
    }
    for (SetObserver<E> observer : snapshot) {
        observer.added(this, element);
    }
}
```

- ì´ì™€ ê°™ì´ ë™ê¸°í™” ì˜ì—­ ë°”ê¹¥ì—ì„œ í˜¸ì¶œë˜ëŠ” ì™¸ê³„ì¸ ë©”ì„œë“œë¥¼ `ì—´ë¦° í˜¸ì¶œ`ì´ë¼ í•œë‹¤.
    - ì™¸ê³„ì¸ ë©”ì„œë“œëŠ” ì–¼ë§ˆë‚˜ ì˜¤ë˜ ì‹¤í–‰í•˜ëŠ”ì§€ ì•Œ ìˆ˜ì—†ë‹¤.
        - ë§Œì•½ ì—´ë¦° í˜¸ì¶œí•˜ì§€ ì•Šê³  ë™ê¸°í™” ì˜ì—­ ì•ˆì—ì„œ í˜¸ì¶œí•œë‹¤ë©´ ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œëŠ” ìì›ì„ ì–»ì§€ ëª»í•˜ê³  í•­ì‹œ ëŒ€ê¸°í•´ì•¼í•¨.
- ì—´ë¦° í˜¸ì¶œì€ ì‹¤íŒ¨ ë°©ì§€ íš¨ê³¼ ì™¸ì—ë„ ë™ì‹œì„± íš¨ìœ¨ë„ ê°œì„ í•´ì¤€ë‹¤.

2. ë” ë‚˜ì€ ë°©ë²•ìœ¼ë¡œ observersì˜ êµ¬í˜„ì²´ìœ¼ë¡œ ì»¬ë ‰ì…˜ì˜ `CopyOnWriteArrayList` ë¥¼ ì´ìš©í•˜ëŠ” ê²ƒë„ ì¢‹ë‹¤.
    - `CopyOnWriteArrayList` :  ArrayList êµ¬í˜„ì²´. ì´ì œ ë‚´ë¶€ ë³€ê²½í•˜ëŠ” ì‘ì—…ì„ í•­ìƒ ë³µì‚¬ë³¸ì„ ë§Œë“¤ì–´ ìˆ˜í–‰í•˜ë„ë¡ êµ¬í˜„í•œ.
    - ë‚´ë¶€ ë°°ì—´ì´ ìˆ˜ì •ë˜ì§€ ì•Šìœ¼ë‹ˆ ìˆœíšŒí•  ë•Œ ë½ì´ í•„ìš”ì—†ì–´ ë§¤ìš°ë¹ ë¦„.(ìˆ˜ì •ì´ ë“œë¬¼ê³  ìˆœíšŒë§Œ ë¹ˆë²ˆí•˜ê²Œ ì¼ì–´ë‚˜ëŠ” ê´€ì°°ì ë¦¬ìŠ¤íŠ¸ ìš©ë„ë¡œ ìµœì )

```java
private final List<SetObserver<E>> observers = new CopyOnWriteArrayList<>();

public void addObserver(SetObserver<E> observer) {
    observers.add(observer);
}

public boolean removeObserver(SetObserver<E> observer) {
    return observers.remove(observer);
}

private void notifyElementAdded(E element) {
    for (SetObserver<E> observer : observers)
        observer.added(this, element);
}
```

### ë™ê¸°í™”ê°€ ì´ˆë˜í•˜ëŠ” ì§„ì§œ ë¹„ìš©
- ê³¼ë„í•œ ë™ê¸°í™”ê°€ ì´ˆë˜í•˜ëŠ” ì§„ì§œ ë¹„ìš©ì€ ë½ì„ ì–»ëŠ” ë° ë“œëŠ” CPU ì‹œê°„ì´ ì•„ë‹ˆë‹¤.
- **ì§„ì§œ ë¹„ìš©ì€ ë©€í‹° ì½”ì–´ ì‹œëŒ€ì—ì„œ ê²½ìŸí•˜ëŠë¼ ë‚­ë¹„í•˜ëŠ” ì‹œê°„, ì¦‰ ì—¬ëŸ¬ CPU ì½”ì–´ê°€ ë³‘ë ¬ë¡œ ì‹¤í–‰í•  ê¸°íšŒë¥¼ ìƒê³ , ëª¨ë“  CPU ì½”ì–´ê°€ ë©”ëª¨ë¦¬ë¥¼ ì¼ê´€ë˜ê²Œ ë³´ê¸° ìœ„í•œ ì§€ì—° ì‹œê°„ì´ë‹¤.**

### ì •ë¦¬
- ë™ê¸°í™” ì˜ì—­ì—ì„œëŠ” ê°€ëŠ¥í•œ í•œ ì¼ì„ ì ê²Œ í•˜ëŠ” ê²ƒì´ ì¤‘ìš”í•˜ë‹¤.
- ê°€ë³€ í´ë˜ìŠ¤ë¥¼ ì‘ì„±í•˜ë ¤ê±°ë“  ë‹¤ìŒ ë‘ ì„ íƒì§€ ì¤‘ í•˜ë‚˜ë¥¼ ë”°ë¥´ì.
    1. ë™ê¸°í™”ë¥¼ ì „í˜€ í•˜ì§€ ë§ê³ , ê·¸ í´ë˜ìŠ¤ë¥¼ ë™ì‹œì— ì‚¬ìš©í•´ì•¼ í•˜ëŠ” í´ë˜ìŠ¤ê°€ ì™¸ë¶€ì—ì„œ ì•Œì•„ì„œ ë™ê¸°í™”í•˜ê²Œ í•˜ì
    2. ë™ê¸°í™”ë¥¼ ë‚´ë¶€ì—ì„œ ìˆ˜í–‰í•´ ìŠ¤ë ˆë“œ ì•ˆì „í•œ í´ë˜ìŠ¤ë¡œ ë§Œë“¤ì (ì•„ì´í…œ 82)
        - í´ë¼ì´ì–¸íŠ¸ê°€ ì™¸ë¶€ì—ì„œ ê°ì²´ ì „ì²´ì— ë½ì„ ê±°ëŠ” ê²ƒë³´ë‹¤ ë™ì‹œì„±ì„ ì›”ë“±íˆ ê°œì„ í•  ìˆ˜ ìˆì„ ë•Œë§Œ ë‘ ë²ˆì§¸ ë°©ë²•ì„ ì„ íƒí•´ì•¼ í•¨
- ì„ íƒí•˜ê¸° ì–´ë µë‹¤ë©´ ë™ê¸°í™”í•˜ì§€ ë§ê³ , ëŒ€ì‹  ë¬¸ì„œì— "ìŠ¤ë ˆë“œ ì•ˆì „í•˜ì§€ ì•Šë‹¤"ë¼ê³  ëª…ê¸°í•˜ì.
- ì—¬ëŸ¬ ìŠ¤ë ˆë“œê°€ í˜¸ì¶œí•  ê°€ëŠ¥ì„±ì´ ìˆëŠ” ë©”ì„œë“œê°€ ì •ì  í•„ë“œë¥¼ ìˆ˜ì •í•œë‹¤ë©´ ê·¸ í•„ë“œë¥¼ ì‚¬ìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ë™ê¸°í•´ì•¼ í•œë‹¤.
